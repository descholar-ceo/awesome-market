services:
  awesome_api:
    build:
      context: .
      dockerfile: deployments/dev/docker/dockerfile
      target: awesome_api_development_image
    container_name: awesome_api_container
    volumes:
      - type: bind
        source: .
        target: /awesome-market
    command: sh -c "yarn migration:run && yarn start:debug"
    env_file:
      - "./.env"
    ports:
      - $HOST_PORT:$PORT
    networks:
      - awesome_network
    restart: always
    profiles:
      - api

  awesome_postgres:
    image: postgres:14-alpine
    container_name: awesome_db_container
    # command: sh -c "psql -U $DB_USERNAME -d $DB_DATABASE -c 'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'"
    env_file:
      - "./.env"
    environment:
      POSTGRES_USER: $DB_USERNAME
      POSTGRES_PASSWORD: $DB_PASSWORD
      POSTGRES_DB: $DB_DATABASE
    volumes:
      - type: volume
        source: postgres_data
        target: /var/lib/postgresql
    ports:
      - $HOST_DB_PORT:$DB_PORT
    networks:
      - awesome_network
    restart: always
    profiles:
      - db

networks:
  awesome_network:
    external: true

volumes:
  postgres_data:
    driver: local
